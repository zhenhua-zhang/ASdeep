#!/bin/bash
# Author    : Zhenhua Zhang
# E-mail    : zhenhua.zhang217@gmail.com
# Created   : 2020 Apr 01

set -eu -o pipefail

# Workspace
projdir=$HOME/Documents/projects/wp_ase_dlp
iptdir=$projdir/inputs
optdir=$projdir/outputs

# Parameters. tissue variable only works when cohort_id is gtex
cohort_id=GTEx
tissue=WHLBLD
n_epoch=150
architecture=resnet
# ENSG00000127507 ENSG00000090382
gene_id=ENSG00000026297
gene_id=ENSG00000108405 
gene_id=ENSG00000162511

# Control the outputs
time_stamp=$(date +%Y%m%d-%H%M%S)
output_dir=$optdir/aseModels/$cohort_id/$gene_id
model_path=$output_dir/$time_stamp"_pytorch_model_state.pth"
train_log_path=$output_dir/$time_stamp"_tensorboard_log"
loss_curve_path=$output_dir/$time_stamp"_training_losscurve.pdf"
sbatch_log_path=$output_dir/$time_stamp"_%j_%u_asedlp_train.log"
sbatch_job_name=${cohort_id}_${gene_id}_asedlp_train

echo_help() {
    echo -e "Usage: $0 [-d/--debug] [-D/--dry-run] [-s/--sbatch]"
    echo -e "  -d, --debug     Using BASH to run the script to debug the script."
    echo -e "  -s, --sbatch    Submit the script to SLURM."
    echo -e "  -D, --dry-run   Print the script to be excuted."
    echo -e "  -h, --help      Print this message and exit."
}

if [[ ! -d $output_dir ]]; then
    mkdir -p $output_dir
fi

flags=""
case ${1:--D} in
    -d|--debug)
        execmd=bash
        ;;
    -D|--dry-run)
        execmd=cat
        ;;
    -s|--sbatch)
        execmd="sbatch
        --mem=40G
        --time=1:59:0
        --partition=gpushort
        --gres=gpu:v100:1
        --cpus-per-task=12
        --output=$sbatch_log_path
        --job-name=$sbatch_job_name"
        ;;
    -h|--help)
        echo_help
        exit
        ;;
    *)
        echo_help

        echo -e "\n[E]: Unknown option $1. Exit..."
        exit
esac


# Determine inputs according to cohort
case $cohort_id in
    BIOS_Geuvadis)
        file_pat=$projdir'/outputs/aseQuan_v2/*/optDir/*/aseqOptDir/*-dup-*.fa'
        ;;
    BIOS)
        bios_cohorts='{CODAM,LL,LLS_660Q,LLS_OminExpr,PAN,RS,gonl}'
        file_pat=$projdir'/outputs/aseQuan_v2/'$bios_cohorts'/optDir/*/aseqOptDir/*-dup-*.fa.gz'
        ;;
    DEBUG)
        file_pat=$projdir'/outputs/aseQuan_v2/{CODAM}/optDir/*/aseqOptDir/*-dup-*.fa.gz'
        ;;
    Geuvadis)
        file_pat=$projdir'/outputs/aseQuan_v2/Geuvadis/optDir/*/aseqOptDir/*-dup-*.fa.gz'
        ;;
    GTEx)
        file_pat=$projdir'/outputs/aseQuan_v2/GTEx/optDir/*/aseqOptDir/*-nondup-'$tissue'-*.fa.gz'
        ;;
    *)
        echo Unknown cohort_id
        exit -1
        ;;
esac


$execmd <<EOF
#!/bin/bash
set -eu -o pipefail

# Check host name
case \$(hostname) in
    umcg-node* | calculon* | gearshift* | gs-vcompute*)
        source /apps/modules/modules.bashrc
        module purge
        module load Python/3.6.3-foss-2015b
        module list
        ;;
    pg-interactive* | pg-node* | pg-gpu*)
        module purge
        module load Python/3.7.4-GCCcore-8.3.0
        module list
        ;;
    genetics*)
        echo "On local machine genetics."
        ;;
    *)
        echo "[E]: Unknown hostname"
        exit
esac

source $projdir/scripts/.env/bin/activate
asedeep train \
    --file-path ${file_pat} \
    --gene-id ${gene_id} \
    --n-epoch ${n_epoch} \
    --prebuilt-arch ${architecture} \
    --model-state-path ${model_path} \
    --loss-curve-path ${loss_curve_path} \
    --logging-path ${train_log_path} \
    --pp-train 0.9 \
    --batch-size 32 \
    --log-per-n-epoch 1
EOF
