#!/bin/bash
# File name : asedlp_train.sh
# Author    : Zhenhua Zhang
# E-mail    : zhenhua.zhang217@gmail.com
# Created   : 2020 Apr 01
# Version   : v0.2.0
# License   : MIT

set -eu -o pipefail

pjdir=~/Documents/projects/wp_ase_dlp
ipdir=${pjdir}/inputs
opdir=${pjdir}/outputs
spdir=${pjdir}/scripts

model_state_dir=${opdir}/models/version_0.1.0

file_pat=${pjdir}/'workdir/optdir/**/aseOptdir/train_set/*_17_matrix_and_ase.npz'
gene_id=ENSG00000161570

output_dir=${model_state_dir}/${gene_id}
mkdir -p "${output_dir}"

n_epoch=50
time_stamp=$(date +%Y%m%d_%H%M%S)
model_state_path=${output_dir}/${time_stamp}.model_state.ptz
logging_path=${output_dir}/${time_stamp}.tensorboard_log
sbatch_log_path=${output_dir}/${time_stamp}.%j.%u.asedlp_train.log


sbatch \
    --mem=5G \
    --ntasks=1 \
    --time=0:29:0 \
    --output=${sbatch_log_path} \
    --job-name=${gene_id}.asedlp_pred <<EOF
#!/bin/bash
set -eu -o pipefail

# Check host name
case \$(hostname) in
    umcg-node* | calculon | boxy)
        source /apps/modules/modules.bashrc
        module purge
        module load Python/3.6.3-foss-2015b
        module list
        ;;
    pg-interactive* | pg-node* | pg-gpu*)
        module purge
        module load Python/3.7.4-GCCcore-8.3.0
        module list
        ;;
    genetics)
        echo "On local machine genetics."
        ;;
    *)
        echo "[E]: Unknown hostname"
        exit
esac


${spdir}/asedlp/asedlp predict \
    --gene-id ENSG00000026297 \
    --file-path \
    --save-path \
    --model-state-path \
    --show-attributions

EOF
