#!/bin/bash
# Author    : Zhenhua Zhang
# E-mail    : zhenhua.zhang217@gmail.com
# Created   : 2020 Apr 01

set -eu -o pipefail

projdir=~/Documents/projects/wp_ase_dlp
iptdir=$projdir/inputs
optdir=$projdir/outputs

cohort=$1
tissue=MSCLSK

output_dir=$optdir/aseReports/$cohort
sbatch_job_name=$cohort-asedlp-report
sbatch_log_path=$output_dir/%j-%u-asedlp-report.log

reqtime=0:10:0
reqmem=2G
case $cohort in
    BIOS)
        bios='{CODAM,LL,LLS_660Q,LLS_OminExpr,PAN,NTR_Affy6,RS,gonl}'
        file_pat=$projdir/outputs/aseQuan_v2/$bios/optDir/'*/aseqOptDir/*-dup-*.txt'
        reqtime=0:29:0
        reqmem=16G
        ;;
    BIOS_Geuvadis)
        bios_geuvadis='{CODAM,LL,LLS_660Q,LLS_OminExpr,PAN,NTR_Affy6,RS,gonl,Geuvadis}'
        file_pat=$projdir/outputs/aseQuan_v2/$bios_geuvadis'/optDir/*/aseqOptDir/*-dup-*.txt'
        reqtime=0:29:0
        reqmem=16G
        ;;
    CODAM|LL|LLS_660Q|LLS_OminExpr|PAN|RS|gonl|Geuvadis)
        file_pat=$projdir/outputs/aseQuan_v2/$cohort/optDir/'*/aseqOptDir/*-dup-*.txt'
        ;;
    GTEx)
        reqtime=0:10:0
        reqmem=8G
        file_pat=$projdir/outputs/aseQuan_v2/$cohort/optDir/'*/aseqOptDir/*-nondup-'$tissue'-*.txt'
        output_dir=$output_dir/$tissue
        sbatch_log_path=$output_dir/%j-%u-asedlp-report.log
        ;;
    *)
        echo Unknown cohort
        exit -1
        ;;
esac

if [[ ! -d $output_dir ]]; then
    mkdir -p $output_dir
fi

sbatch \
    --mem=$reqmem \
    --time=$reqtime \
    --output=$sbatch_log_path \
    --job-name=$sbatch_job_name <<EOF
#!/bin/bash
set -eu -o pipefail

# Check host name
case \$(hostname) in
    umcg-node* | calculon | gear)
        source /apps/modules/modules.bashrc
        module purge
        module load Python/3.6.3-foss-2015b
        module list
        ;;
    pg-interactive* | pg-node* | pg-gpu*)
        module purge
        module load Python/3.7.4-GCCcore-8.3.0
        module list
        ;;
    genetics)
        echo "On local machine genetics."
        ;;
    *)
        echo "[E]: Unknown hostname"
        exit
esac

source $projdir/scripts/.env/bin/activate
asedeep report \
    -p $file_pat \
    -f $iptdir/Ensembl_references/Homo_sapiens.GRCh37.75.db \
    -e $iptdir/Ensembl_references/MHClocus-geneid.txt \
    -o $output_dir/asedlp_report_exMHC

EOF
